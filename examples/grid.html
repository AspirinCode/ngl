<!DOCTYPE html>
<html lang="en">
<head>
    <title>NGL - grid</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
    <script src="../build/js/ngl.dev.js"></script>
    <script>
        var stage, viewport;
        var width = 200;
        var height = 150;
        var hiddenImg;

        function loadList( pdbList ){
            pdbList.reduce( function( acc, name ){
                return acc.then( function(){
                    return stage.loadFile( "rcsb://" + name )
                        .then( prepareImage )
                        .then( makeImage )
                        .then( appendImage );
                } );
            }, Promise.resolve() ).then( function(){
                console.log( "done" )
            } );
        }

        function prepareImage( o ){
            stage.eachRepresentation( function( r ){
                r.dispose();
            } );
            stage.defaultFileRepresentation( o );
            o.autoView();
            stage.autoView();
            return o.name;
        }

        function showEntry( name ){
            var o = stage.getComponentsByName( name ).list[ 0 ];
            prepareImage( o );
        }

        function makeImage( name ){
            return stage.makeImage().then( function( imgBlob ){
                return [ name, imgBlob ];
            } );
        }

        function sample( array, n ){
            n = Math.max( Math.min( n, array.length ), 0 );
            var last = array.length - 1;
            for( var index = 0; index < n; ++index ){
                var rand = index + Math.floor( Math.random() * ( last - index + 1 ) );
                var temp = array[ index ];
                array[ index ] = array[ rand ];
                array[ rand ] = temp;
            }
            return array.slice( 0, n );
        }

        function appendImage( nameAndBlob ){
            var div = document.createElement( "div" );
            div.style.display = "inline-block";
            div.appendChild( viewport );
            document.body.appendChild( div );

            var name = nameAndBlob[ 0 ];
            var blob = nameAndBlob[ 1 ];
            var objectURL = URL.createObjectURL( blob );
            var img = document.createElement( "img" );
            img.src = objectURL;
            img.style.width = width + "px";
            img.style.height = height + "px";
            img.title = name;
            img.style.display = "none";
            img.onclick = function(){
                console.log( name )
                img.style.display = "none";
                div.appendChild( viewport );
                if( hiddenImg ){
                    hiddenImg.style.display = "inline-block";
                }
                hiddenImg = img;
                showEntry( name );
            };
            if( hiddenImg ){
                hiddenImg.style.display = "inline-block";
            }
            hiddenImg = img;
            div.appendChild( img );
        }

        function loadArchive( count ){
            var xhr = new XMLHttpRequest();
            xhr.open( "GET", "http://www.rcsb.org/pdb/json/getCurrent" );
            xhr.responseType = "json";
            xhr.onload = function(){
                list = sample( this.response.idList, count );
                loadList( list );
            };
            xhr.send();
        }

        document.addEventListener( "DOMContentLoaded", function(){
            viewport = document.createElement( "div" );
            viewport.style.display = "inline-block";
            viewport.style.width = width + "px";
            viewport.style.height = height + "px";
            document.body.appendChild( viewport );
            stage = new NGL.Stage( viewport, { backgroundColor: "white" } );

            var archive = NGL.getQuery( "archive" );
            var list = NGL.getQuery( "list" );
            if( archive ){
                loadArchive( archive );
            }else if( list ){
                loadList( list.split( "," ) );
            }else{
                loadArchive( 30 );
            }
        } );
    </script>
</body>
</html>
